<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Frames</title>
    <style>
      body {
        margin: 0;
        background: #000;
        font-family: "Noto Sans TC", -apple-system, BlinkMacSystemFont, "Segoe UI",
      "PingFang TC", "Microsoft JhengHei", sans-serif;
      }
    </style>
  </head>
  <body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.1/gsap.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.1/ScrollTrigger.min.js"></script>
 <script type="text/javascript">
function initializeGSAPAnimation() {
  
  // *** 時序檢查：等待 GSAP 載入 (保留) ***
  if (typeof gsap === 'undefined' || typeof ScrollTrigger === 'undefined') {
    setTimeout(initializeGSAPAnimation, 100);  
    return;
  }
  
  // 動態創建 Canvas 元素 (保留)
  let canvas = document.getElementById("sequence");
  if (!canvas) {
    canvas = document.createElement("canvas");
    canvas.id = "sequence";
    canvas.style.position = "fixed"; 
    canvas.style.top = "0"; 
    canvas.style.left = "0"; 
    canvas.style.width = "100vw"; 
    canvas.style.height = "100vh"; 
    canvas.style.objectFit = "cover";
    canvas.style.zIndex = "9999"; 
    document.body.prepend(canvas);
    document.body.style.backgroundColor = '#000';
    document.body.style.overflowX = 'hidden';
  }

  // 初始化
  gsap.registerPlugin(ScrollTrigger);
  const frameCount = 16; 
  const currentFrame = (index) => `./img/frames/bg_${index}.JPG`; // 檢查此路徑是否正確！
  const context = canvas.getContext("2d");
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  const images = [];
  const frame = { index: 0 };
  
  // *** 修正的重點在這裡：預載計數器 ***
  let imagesLoadedCount = 0;
  
  // 繪圖函式 ( render 函式必須定義在圖片載入之前才能被 onload 呼叫 )
  function render() {
    const imgIndex = Math.floor(frame.index);
    const img = images[imgIndex];
    
    // ** 【關鍵修正】在繪製前，確保圖片已載入且未破損 **
    if (!img || !img.complete || img.naturalWidth === 0) return; 

    // console.log('目前顯示的圖片 index:', imgIndex + 1);

    const scale = Math.max(
      canvas.width / img.width,
      canvas.height / img.height
    );

    const x = 400;
    const y = -700;
    
    context.clearRect(0, 0, canvas.width, canvas.height);
    context.drawImage(img, x, y, img.width * scale, img.height * scale);
  }


  // 啟動 GSAP 動畫的函式，只有在所有圖片都載入後才會執行
  function startGSAPAnimation() {
      // 確保初始狀態正確
      render(); 
      
      // 使用 GSAP 與 ScrollTrigger 連動
      gsap.to(frame, {
        index: frameCount - 1,
        snap: "index",
        ease: "none",
        scrollTrigger: {
          scrub: true,
          trigger: canvas, 
          start: "top top",
          end: () => "+=" + window.innerHeight * 10,
          markers: true,
        },
        onUpdate: render,
      });

      // 視窗調整時重新繪製
      window.addEventListener("resize", () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        render();
      });
      
      console.log('所有圖片載入完成，GSAP 動畫啟動！');
  }

  // 預載所有圖片
  for (let i = 1; i <= frameCount; i++) {
    const img = new Image();
    
    // 監聽載入事件
    img.onload = () => {
        imagesLoadedCount++;
        // 如果所有圖片都載入完成，則啟動動畫
        if (imagesLoadedCount === frameCount) {
            startGSAPAnimation();
        }
    };
    
    // 監聽錯誤事件 (圖片載入失敗也會報錯，導致計數器無法達到 frameCount)
    img.onerror = () => {
        imagesLoadedCount++;
        console.error(`圖片載入失敗: ${img.src}`);
        // 即使失敗，也必須讓計數器增加，否則動畫永遠不會啟動
        if (imagesLoadedCount === frameCount) {
            startGSAPAnimation();
        }
    };
    
    img.src = currentFrame(i);
    images.push(img);
  }
}

initializeGSAPAnimation();
</script>
    </div>
  </body>
</html>
